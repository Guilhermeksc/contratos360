<app-janela-generica
  [titulo]="popupTitle"
  [mostrar]="mostrar"
  [mostrarBotaoFechar]="true"
  [maxWidth]="'95vw'"
  [botoes]="botoes"
  [mostrarFooter]="false"
  [isLoading]="loading()"
  [headerAlertText]="(hasUnsavedChanges() || hasUnsavedStatusChanges()) ? 'Alterações não salvas' : null"
  [headerButton]="headerButton"
  (fechar)="tentarFecharPopup()">
  
  <div class="record-popup-content">
    <!-- Loading -->
    <div *ngIf="loading()" class="loading-message">
      <mat-icon>hourglass_empty</mat-icon>
      <span>Carregando detalhes do contrato...</span>
    </div>

    <!-- Conteúdo -->
    <div *ngIf="!loading() && contract()" class="details-content">
      <mat-tab-group>
        <!-- Tab Informações Gerais -->
        <mat-tab label="Informações Gerais">
          <div class="tab-content two-columns">
            <!-- Coluna Esquerda: Informações do Contrato (somente leitura) -->
            <div class="left-column">
              <div class="info-item">
                <label>Número:</label>
                <span>{{ contract()?.numero || 'N/A' }}</span>
              </div>
              <div class="info-item">
                <label>Número Licitação:</label>
                <span>{{ contract()?.licitacao_numero || 'N/A' }}</span>
              </div>
              <div class="info-item">
                <label>Processo (NUP):</label>
                <span>{{ contract()?.processo || 'N/A' }}</span>
              </div>
              <div class="info-item">
                <label>Fornecedor:</label>
                <span>{{ contract()?.fornecedor_nome || 'N/A' }}</span>
              </div>
              <div class="info-item">
                <label>CNPJ:</label>
                <span>{{ contract()?.fornecedor_cnpj || 'N/A' }}</span>
              </div>
              <div class="info-item">
                <label>Valor:</label>
                <span>{{ formatCurrency(contract()?.valor_global ?? null) }}</span>
              </div>
              <div class="info-item">
                <label>Vigência:</label>
                <span>{{ formatDate(contract()?.vigencia_inicio ?? null) }} até {{ formatDate(contract()?.vigencia_fim ?? null) }}</span>
              </div>
              <div class="info-item full-width">
                <label>Objeto:</label>
                <span>{{ contract()?.objeto || 'N/A' }}</span>
              </div>
            </div>

            <!-- Coluna Direita: Formulário Editável -->
            <div class="right-column">
              <app-status-contrato
                #statusFormComponent
                [contratoId]="contratoId"
                [contract]="contract()"
                (statusSaved)="onStatusSaved($event)"
                (unsavedChanges)="onStatusUnsavedChanges($event)">
              </app-status-contrato>
            </div>
          </div>
        </mat-tab>

        <!-- Tab Fiscalização -->
        <mat-tab label="Fiscalização">
          <div class="tab-content">
            <app-fiscalizacao-contrato
              [fiscalizacao]="contract()?.fiscalizacao ?? null">
            </app-fiscalizacao-contrato>
          </div>
        </mat-tab>

        <!-- Tab Status -->
        <mat-tab label="Status">
          <div class="tab-content">
            <app-status-contrato-view
              #statusViewComponent
              [status]="contract()?.status ?? null"
              [registrosStatus]="registrosStatus"
              [registrosMensagem]="registrosMensagem"
              [contratoId]="contratoId"
              [uasgCode]="contract()?.uasg ?? ''"
              (statusUpdated)="onStatusUpdated($event)"
              (registrosUpdated)="onRegistrosUpdated()"
              (unsavedChanges)="onStatusTabUnsavedChanges($event)">
            </app-status-contrato-view>
          </div>
        </mat-tab>

        <!-- Tab Empenhos -->
        <mat-tab label="Empenhos">
          <div class="tab-content">
            <app-empenhos-contrato
              [contratoId]="contratoId">
            </app-empenhos-contrato>
          </div>
        </mat-tab>

        <!-- Tab Itens -->
        <mat-tab label="Itens">
          <div class="tab-content">
            <app-itens-contrato
              [contratoId]="contratoId">
            </app-itens-contrato>
          </div>
        </mat-tab>

        <!-- Tab Histórico -->
        <mat-tab label="Histórico">
          <div class="tab-content">
            <app-historico-contrato
              [contratoId]="contratoId"
              [historicos]="[]">
            </app-historico-contrato>
          </div>
        </mat-tab>

        <!-- Tab Extras -->
        <mat-tab label="Extras">
          <div class="tab-content">
            <div class="info-grid">
              <div class="info-item">
                <label>Históricos:</label>
                <span>{{ contract()?.historicos_count || 0 }}</span>
              </div>
              <div class="info-item">
                <label>Empenhos:</label>
                <span>{{ contract()?.empenhos_count || 0 }}</span>
              </div>
              <div class="info-item">
                <label>Itens:</label>
                <span>{{ contract()?.itens_count || 0 }}</span>
              </div>
              <div class="info-item">
                <label>Arquivos:</label>
                <span>{{ contract()?.arquivos_count || 0 }}</span>
              </div>
              <div class="info-item">
                <label>Manual:</label>
                <span>{{ contract()?.manual ? 'Sim' : 'Não' }}</span>
              </div>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
    </div>

    <!-- Erro -->
    <div *ngIf="!loading() && !contract()" class="error-message">
      <mat-icon>error</mat-icon>
      <p>Erro ao carregar detalhes do contrato.</p>
    </div>
  </div>
</app-janela-generica>
