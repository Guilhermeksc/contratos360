<div class="contracts-table-container">
  <!-- Toolbar -->
  <div class="toolbar">
    <button mat-button [matMenuTriggerFor]="uasgMenu" class="toolbar-button">
      <mat-icon>storage</mat-icon>
      <span>UASG</span>
    </button>
    <mat-menu #uasgMenu="matMenu">
      <button mat-menu-item *ngFor="let uasg of uasgs()" (click)="filterByUasg(uasg.uasg_code)">
        {{ uasg.uasg_code }} - {{ uasg.nome_resumido }}
      </button>
    </mat-menu>
    
    <button mat-button (click)="openMessages()" class="toolbar-button">
      <mat-icon>message</mat-icon>
      <span>Mensagens</span>
    </button>
    
    <button mat-icon-button (click)="clearTable()" [matTooltip]="mode() === 'Online' ? 'Limpar Tabela (Modo Online)' : 'Limpar Tabela (Modo Offline)'" class="icon-button">
      <mat-icon>{{ mode() === 'Online' ? 'link' : 'storage' }}</mat-icon>
    </button>
    
    <span class="spacer"></span>
    
    <label class="uasg-info">UASG: {{ currentUasg() || '-' }}</label>
  </div>
  
  <!-- Barra de Busca -->
  <mat-form-field appearance="outline" class="search-bar">
    <mat-label>Buscar</mat-label>
    <input matInput [(ngModel)]="searchTerm" (input)="applyFilter()" placeholder="Número, processo, fornecedor, objeto...">
    <mat-icon matPrefix>search</mat-icon>
  </mat-form-field>
  
  <!-- Tabela -->
  <div class="table-wrapper">
    <table mat-table [dataSource]="dataSource" matSort class="contracts-table">
      <ng-container matColumnDef="uasg">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>UASG</th>
        <td mat-cell *matCellDef="let row">{{ row.uasg }}</td>
      </ng-container>
      
      <ng-container matColumnDef="numero">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Número</th>
        <td mat-cell *matCellDef="let row">{{ row.numero }}</td>
      </ng-container>
      
      <ng-container matColumnDef="processo">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Processo</th>
        <td mat-cell *matCellDef="let row">{{ row.processo }}</td>
      </ng-container>
      
      <ng-container matColumnDef="fornecedor_nome">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Fornecedor</th>
        <td mat-cell *matCellDef="let row" class="text-truncate">{{ row.fornecedor_nome }}</td>
      </ng-container>
      
      <ng-container matColumnDef="valor_global">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Valor</th>
        <td mat-cell *matCellDef="let row">{{ formatCurrency(row.valor_global) }}</td>
      </ng-container>
      
      <ng-container matColumnDef="vigencia_fim">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Vigência Fim</th>
        <td mat-cell *matCellDef="let row">{{ formatDate(row.vigencia_fim) }}</td>
      </ng-container>
      
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Status</th>
        <td mat-cell *matCellDef="let row">
          <app-status-badge [status]="row.status_atual || 'SEÇÃO CONTRATOS'"></app-status-badge>
        </td>
      </ng-container>
      
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Ações</th>
        <td mat-cell *matCellDef="let row">
          <button mat-icon-button [matMenuTriggerFor]="menu">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="openDetails(row.id)">
              <mat-icon>visibility</mat-icon>
              <span>Ver Detalhes</span>
            </button>
            <button mat-menu-item (click)="generateReport(row.id)">
              <mat-icon>description</mat-icon>
              <span>Gerar Relatório</span>
            </button>
            <button mat-menu-item (click)="deleteContract(row.id)">
              <mat-icon>delete</mat-icon>
              <span>Deletar</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>
      
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns" (contextmenu)="showContextMenu($event, row)"></tr>
      
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" [attr.colspan]="displayedColumns.length">
          <div class="empty-message">Nenhum contrato encontrado</div>
        </td>
      </tr>
    </table>
  </div>
  
  <!-- Paginação -->
  <mat-paginator 
    [pageSizeOptions]="[25, 50, 100]" 
    [pageSize]="25"
    showFirstLastButtons
    [length]="dataSource.data.length">
  </mat-paginator>
  
  <!-- Loading indicator -->
  <div *ngIf="loading()" class="loading-overlay">
    <mat-icon>hourglass_empty</mat-icon>
    <span>Carregando contratos...</span>
  </div>

  <!-- Popup de Detalhes -->
  <app-contract-details-popup
    [contratoId]="selectedContratoId()"
    [mostrar]="showDetailsPopup()"
    (fechar)="closeDetailsPopup()">
  </app-contract-details-popup>
</div>

